<!DOCTYPE html>
<meta charset="utf-8" />
<title>Pong ≤150</title>
<canvas id="c" style="background:#000;position:fixed;inset:0"></canvas>
<script>
  const c=document.getElementById("c"),ctx=c.getContext("2d"),TAU=Math.PI*2;
  const SPEEDUP=1.08,MAXS=14;

  let W=0,H=0,keys={},paused=false,gameOver=false,atMenu=true,msg="";
  let AC,audOK=false,pScore=0,aScore=0,winScore=7,p,a,ball;

  function resize(){
    c.width=W=innerWidth;c.height=H=innerHeight
  }
  addEventListener("resize",resize);
  resize();

  function startAudio(){
    if(audOK)return;
    AC=new (window.AudioContext||webkitAudioContext)();
    audOK=true
  }
  
  function beep(f,d=.08,t="square",v=.2){
    if(!audOK)return;

    const o=AC.createOscillator(),g=AC.createGain(),x=AC.currentTime;
    o.type=t; o.frequency.value=f; g.gain.value=v; o.connect(g); g.connect(AC.destination); o.start(x);
    g.gain.exponentialRampToValueAtTime(0.0001,x+d); o.stop(x+d)
  }
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));

  function serve(dir=1){
    ball={x:W/2,y:H/2,vx:dir*(4+Math.random()*2),vy:(Math.random()-.5)*4,r:8}
  }
  
  function reset(){
    p={x:30,y:H/2-50,w:12,h:100,spd:7};a={x:W-42,y:H/2-50,w:12,h:100,spd:6};pScore=aScore=0;gameOver=false;msg="";serve(Math.random()<.5?1:-1)
  }
  
  onkeydown=onkeyup=e=>{
    keys[e.key]=e.type==="keydown";
    
    if(e.type==="keydown"){startAudio();if((e.key==="p"||e.key==="P")&&!atMenu)paused=!paused;
    if(atMenu&&(e.key==="Enter"||e.key===" "))atMenu=false}
  };
  
  addEventListener("keydown",e=>{
    if(gameOver&&(e.key==="r"||e.key==="R"))reset()
  });
  
  addEventListener("pointerdown",e=>{
    if(!atMenu)return;startAudio();
    
    const r=c.getBoundingClientRect(),x=e.clientX-r.left,y=e.clientY-r.top,bw=220,bh=50,bx=W/2-bw/2,by=H/2+40;
    
    if(x>bx&&x<bx+bw&&y>by&&y<by+bh)atMenu=false;
  });
  
  function draw(){
    ctx.clearRect(0,0,W,H);
    
    if(atMenu){
      const w=520,h=260,x=W/2-w/2,y=H/2-h/2;
      ctx.fillStyle="rgba(0,0,0,.7)";ctx.fillRect(x,y,w,h);
      ctx.strokeStyle="#fff";ctx.strokeRect(x+2,y+2,w-4,h-4);
      ctx.fillStyle="#fff";ctx.font="28px monospace";
      const title="PONG";ctx.fillText(title,W/2-ctx.measureText(title).width/2,y+50);
      ctx.font="16px monospace";
      const ln1="First to 7 points wins.",ln2="Controls: ↑/↓ or W/S — P: Pause — R: Restart";
      ctx.fillText(ln1,W/2-ctx.measureText(ln1).width/2,y+90);
      ctx.fillText(ln2,W/2-ctx.measureText(ln2).width/2,y+115);
      const bw=220,bh=50,bx=W/2-bw/2,by=H/2+40;
      ctx.fillStyle="#0f0";ctx.fillRect(bx,by,bw,bh);
      ctx.strokeStyle="#003300";ctx.strokeRect(bx,by,bw,bh);
      ctx.fillStyle="#000";ctx.font="22px monospace";
      const st="START GAME";ctx.fillText(st,W/2-ctx.measureText(st).width/2,by+32);
      return;
    }
    
    ctx.setLineDash([8,8]);ctx.strokeStyle="#333";ctx.beginPath();ctx.moveTo(W/2,0);ctx.lineTo(W/2,H);ctx.stroke();ctx.setLineDash([]);
    ctx.fillStyle="#0f0";ctx.fillRect(p.x,p.y,p.w,p.h);
    ctx.fillStyle="#f55";ctx.fillRect(a.x,a.y,a.w,a.h);
    ctx.fillStyle="#ff0";ctx.beginPath();ctx.arc(ball.x,ball.y,ball.r,0,TAU);ctx.fill();
    ctx.fillStyle="#0f0";ctx.font="24px monospace";ctx.fillText(pScore,W/2-60,40);ctx.fillText(aScore,W/2+40,40);
    
    if(paused){ctx.fillStyle="#888";ctx.font="20px monospace";ctx.fillText("PAUSED (P)",12,40)}
    
    if(gameOver){
      const w=420,h=140,x=W/2-w/2,y=H/2-h/2;
      ctx.fillStyle="rgba(0,0,0,.7)";ctx.fillRect(x,y,w,h);
      ctx.strokeStyle="#fff";ctx.strokeRect(x+2,y+2,w-4,h-4);
      ctx.fillStyle="#fff";ctx.font="28px monospace";ctx.fillText(msg,W/2-ctx.measureText(msg).width/2,H/2-10);
      const sub="Press R to restart";ctx.font="18px monospace";ctx.fillText(sub,W/2-ctx.measureText(sub).width/2,H/2+28);
    }
  }
  
  function capBall(){
    const s=Math.hypot(ball.vx,ball.vy);if(s>MAXS){const k=MAXS/s;ball.vx*=k;ball.vy*=k}
  }
  
  function update(){
    if(atMenu||paused||gameOver){draw();requestAnimationFrame(update);return}
    if(keys.ArrowUp||keys.w||keys.W)p.y-=p.spd;
    if(keys.ArrowDown||keys.s||keys.S)p.y+=p.spd;
    
    p.y=clamp(p.y,0,H-p.h);
    let target;
    
    if(ball.vx>0){
      const dist=(a.x-ball.x)/W; 
      const err=(Math.random()-.5)*12*dist; 
      target=ball.y+ball.vy*8 - a.h/2 + err;
    }else{
      target=H/2 - a.h/2; 
    }
    
    a.y+=clamp(target-a.y,-a.spd,a.spd);a.y=clamp(a.y,0,H-a.h);
    ball.x+=ball.vx;ball.y+=ball.vy;
    
    if(ball.y<ball.r||ball.y>H-ball.r){ball.vy*=-1;ball.y=clamp(ball.y,ball.r,H-ball.r);beep(300,.04,"triangle",.18)}
    
    function paddleHit(P,dir){
      
        if(ball.vx*dir>0&&ball.x+ball.r>P.x&&ball.x-ball.r<P.x+P.w&&ball.y>P.y&&ball.y<P.y+P.h){
            const off=(ball.y-(P.y+P.h/2))/(P.h/2);
            ball.vx=-ball.vx*SPEEDUP;ball.vy=(ball.vy+off*6)*SPEEDUP;capBall();beep(700,.06);
            ball.x=P.x+(dir>0?-ball.r:P.w+ball.r);
        } 
    }
    paddleHit(p,-1);
    paddleHit(a,1);

    if(ball.x<-ball.r){aScore++;beep(400,.08,"sawtooth",.25);setTimeout(()=>beep(220,.12,"sawtooth",.25),90);serve(1)}
    if(ball.x>W+ball.r){pScore++;beep(300,.06,"square",.25);setTimeout(()=>beep(600,.10,"square",.25),80);serve(-1)}
    if(pScore>=winScore||aScore>=winScore){gameOver=true;msg=pScore>aScore?"YOU WIN":"YOU LOSE"}
    
    draw();
    requestAnimationFrame(update);
  }
  reset();
  update();
</script>
